<template>
    <v-carousel cycle :show-arrows="false" delimiter-icon="mdi-square" delimiter-color="light_green" height="267"
        interval="5000" hide-delimiter-background>
        <v-carousel-item v-for="(image, index) in images" :key="index" style="overflow: hidden;">
            <img :src="image.src" :alt="image.alt" class="banner-img" />
        </v-carousel-item>
    </v-carousel>
    <v-container class="custom-container">
        <!-- Top 10 Ìå®ÌÇ§ÏßÄ ÏãúÏûë -->
        <v-card style="border-radius: 15px; padding: 20px; padding-bottom: 0px; max-width: 1200px; width: 100%;"
            rounded="0" flat>
            <v-card-title style="font-size: 20px;"> <span style="font-weight: bold;">üèÜ BEST 10 </span>
                <span style="font-size: 15px; color: grey;"> ÏßÄÍ∏à Í∞ÄÏû• Ïù∏Í∏∞ÏûàÎäî Ìå®ÌÇ§ÏßÄÎ•º ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî ! </span>
            </v-card-title>
            <br />
            <Best10PackageSlide />
        </v-card>
        <!-- Top 10 Ìå®ÌÇ§ÏßÄ ÎÅù -->

        <br>
        <div class="hr-style"></div>
        <br>

        <!-- Ìå®ÌÇ§ÏßÄ Î¶¨Ïä§Ìä∏ -->
        <v-container style="width: 100%; text-align: start;">

            <v-card-title style="font-size: 20px;"> <span style="font-weight: bold;"> ü•¶ Ìå®ÌÇ§ÏßÄ ÏÇ¥Ìé¥Î≥¥Í∏∞ </span>
            </v-card-title>

            <v-row style="margin-top: 20px; padding-right:1.8%">
                <v-col cols="6"></v-col>
                <v-col cols="2">
                    <div class="select-wrapper">
                        <select v-model="sortOption" class="sort-select" @change="onSearch"> <!-- Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä -->
                            <option v-for="option in sortOptions" :key="option" :value="option">{{ option }}</option>
                        </select>
                        <svg-icon type="mdi" :path="mdiMenuDown" class="dropdown-icon"></svg-icon>
                    </div>
                </v-col>
                <v-col cols="4">
                    <form class="searchbar">
                        <input style="width:100%; margin-left: 15px;" placeholder="Íµ¨ÎèÖ Ìå®ÌÇ§ÏßÄÎ•º Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî!"
                            v-model="searchQuery" @input="onSearch" />
                        <button type="submit" @click.prevent="onSearch">
                            <img style="margin-right:15px; margin-top: 8px"
                                src="https://d3cpiew7rze14b.cloudfront.net/assets/svg/Search-icon-24x-24_qnmx4o57C.svg"
                                alt="Í≤ÄÏÉâ">
                        </button>
                    </form>
                </v-col>


            </v-row>

            <v-container class="d-flex custom-card-container">
                <v-row>
                    <v-card v-for="(pkg, index) in packageList" :key="index" class="package-card" md="2" variant="text"
                        style="width:260px; height:500px; margin: 10px; margin-bottom: 15px;" :rounded="false">
                        <v-img class="package-image" :src="pkg.imageUrl" alt="Package Ïç∏ÎÑ§Ïùº" cover
                            @click="this.$router.push(`/product/${pkg.id}`)" />
                        <v-chip
                            style="position: absolute; top: 10px; left: 10px; padding: 5px 10px; border-radius: 8px; background-color: rgba(128, 128, 128, 0.9); color: white;">
                            {{ pkg.deliveryCycle }}Ïùº Ï£ºÍ∏∞ Î∞∞ÏÜ°üöö
                        </v-chip>
                        <v-btn style="width: 100%; margin-top:10px; border: 0.5px solid gray; box-shadow: none;"
                            @click="addToWishList(pkg)" v-if="member">
                            <div v-if="wishAnimation.get(pkg.id)" class="heart-emoji">
                                <svg-icon type="mdi" :path="mdiHeart" class="icon-colored"></svg-icon>
                            </div>
                            <svg-icon type="mdi" :path="wishlistItems[pkg.id] ? mdiHeart : mdiHeartOutline"
                                :style="{ marginRight: '2px', color: wishlistItems[pkg.id] ? 'red' : 'black' }"
                                class="heart-icon"></svg-icon>
                            <span style="font-size: 14px;">{{ wishlistItems[pkg.id] ? 'ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Ï∑®ÏÜå' : 'ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Îã¥Í∏∞' }}</span>
                        </v-btn>
                        <v-card-text style="padding-left: 0px;">
                            <span style="font-size:medium; font-weight: 400;" v-if="pkg.packageName.length > 20"> {{
                                pkg.packageName.substring(0, 10)
                                }}... </span>
                            <span style="font-size:medium; font-weight: 400;" v-else> {{ pkg.packageName }}</span>
                            <div class="item-info" v-if="pkg.discountId != null && pkg.discountActive == true">
                                <p style="text-decoration: line-through; color: #999; font-size: 14px;">{{
                                    formatPrice(pkg.price) }}</p>
                                <div style="margin-bottom: 2px;">
                                    <span style="color:darkgreen; font-size:medium;">{{ formatPrice(pkg.price -
                                        pkg.discount) }}&nbsp;&nbsp;</span>
                                    <span class="sale-style">SALE</span>
                                </div>
                                <p style="color:#999; font-size: small;"> 1Ìöå Ï†úÍ≥µ Í∏àÏï° {{
                                    formatPrice(getPerCyclePrice(pkg.price - pkg.discount, pkg.deliveryCycle)) }} </p>
                                <p style="color:#999; font-size: small;">
                                    üßæ ÎàÑÏ†Å Ï£ºÎ¨∏ {{ pkg.orderCount }}
                                </p>
                            </div>
                            <div class="item-info" v-else>
                                <p style="color:darkgreen; font-size:medium;">{{ formatPrice(pkg.price) }}</p>
                                <span style="color:#999; font-size: small;"> 1Ìöå Ï†úÍ≥µ Í∏àÏï° {{
                                    formatPrice(getPerCyclePrice(pkg.price, pkg.deliveryCycle)) }} </span>
                                <br />
                                <span style="color:#999; font-size: small;">
                                    üßæ ÎàÑÏ†Å Ï£ºÎ¨∏ {{ pkg.orderCount }}
                                </span>
                            </div>
                        </v-card-text>
                    </v-card>
                </v-row>
            </v-container>
        </v-container>
        <!-- Ìå®ÌÇ§ÏßÄ Î¶¨Ïä§Ìä∏ ÎÅù -->
    </v-container>
</template>

<script>
import axios from 'axios';
import SvgIcon from '@jamescoyle/vue-icon';
import { mdiHeartPlusOutline } from '@mdi/js';
import { mdiHeartOutline, mdiHeart } from '@mdi/js';
import { mdiMenuDown } from '@mdi/js';
import Best10PackageSlide from '@/components/slide/Best10PackageSlide.vue';
import debounce from 'lodash/debounce';

export default {
    name: "my-component",
    components: {
        SvgIcon,
        Best10PackageSlide
    },
    data() {
        return {
            path: mdiHeartPlusOutline,
            topPackageList: [],
            onboarding: 1,
            packageList: [],
            currentPage: 0,
            currentSlide: 1,
            pageSize: 10,
            searchQuery: "",
            sortOptions: [
                "ÏµúÏã†Ïàú", "ÌåêÎß§Îüâ Ïàú"
            ],
            sortOption: "ÏµúÏã†Ïàú",
            sortOptionMap: new Map(),
            isLoading: false,
            isLastPage: false,

            wishlistItems: [],
            mdiHeartOutline: mdiHeartOutline,
            mdiHeart: mdiHeart,
            mdiMenuDown: mdiMenuDown,

            member: localStorage.getItem("memberId"),

            wishAnimation: new Map(),
            images: [],
        }
    },
    computed: {
        windowCount() {
            return Math.ceil(this.topPackageList.length / 4); // ÌéòÏù¥ÏßÄÎãπ 4Í∞úÏùò Ìå®ÌÇ§ÏßÄÍ∞Ä ÌëúÏãúÎêúÎã§Í≥† Í∞ÄÏ†ï
        }
    },
    async created() {
        this.images = [
            { "src": "https://dongsanginong-bucket.s3.ap-northeast-2.amazonaws.com/banner/banner_package1.png", "alt": "Î∞∞ÎÑàÏÇ¨ÏßÑ1", "link": "/event2" },
            { "src": "https://dongsanginong-bucket.s3.ap-northeast-2.amazonaws.com/banner/banner_package2.png", "alt": "Î∞∞ÎÑàÏÇ¨ÏßÑ2", "link": "/event2" },
            { "src": "https://dongsanginong-bucket.s3.ap-northeast-2.amazonaws.com/banner/banner_package3.png", "alt": "Î∞∞ÎÑàÏÇ¨ÏßÑ3", "link": "/event2" },
        ];
        // Top 10 Ìå®ÌÇ§ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
        try {
            const topPackagesResponse = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/product-service/product/no-auth/top10`);
            this.topPackageList = topPackagesResponse.data;
            // Ï†ÑÏ≤¥ Ìå®ÌÇ§ÏßÄ Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
            let params = {
                page: this.currentPage,
                size: this.pageSize,
                sort: this.sortOptionMap.get(this.sortOption),
                packageName: this.searchQuery
            }
            const packageListResponse = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/product-service/product/no-auth`, { params });
            this.packageList = packageListResponse.data.content;
            // sortOptionMap ÏÑ§Ï†ï
            this.sortOptionMap.set("ÏµúÏã†Ïàú", "id,desc");
            this.sortOptionMap.set("ÌåêÎß§Îüâ Ïàú", "orderCount,desc");
        } catch (e) {
            console.log(e);
        }


        // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖòÏùÑ ÏúÑÌïú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        window.addEventListener('scroll', this.scrollPagination); // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                this.onSearch();
            }
        }); // ÏóîÌÑ∞ ÌÇ§ Ïù¥Î≤§Ìä∏
    },
    async mounted() {
        await this.fetchWishlistItems();
        this.startCarousel();
    },
    methods: {
        startCarousel() {
            setInterval(() => {
                this.nextSlide();
            }, 3000);
        },
        nextSlide() {
            this.currentSlide = this.currentSlide % this.windowCount + 1; // Îã§Ïùå Ïä¨ÎùºÏù¥ÎìúÎ°ú Ïù¥Îèô
        },
        async fetchWishlistItems() {
            try {
                const memberId = localStorage.getItem('memberId');
                if (memberId) {
                    const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/member-service/wishlist`);
                    console.log(">>>>>>>>response : ", response.data);

                    const wishlistProductIds = response.data.map(product => product.id);
                    wishlistProductIds.forEach(id => {
                        this.wishlistItems[id] = true;
                    });
                }
            } catch (error) {
                console.error('ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
            }
        },
        formatPrice(value) {
            if (value == null) {
                return "0Ïõê";
            }
            return parseInt(value).toLocaleString('ko-KR') + ' Ïõê'; // ÌïúÍµ≠Ïñ¥ ÌôîÌèê ÏñëÏãùÏúºÎ°ú Î≥ÄÌôò
        },
        getPerCyclePrice(price, deliveryCycle) {
            if (price == null || deliveryCycle == null || deliveryCycle == 0) {
                return 0; // Í∞íÏù¥ ÏóÜÍ±∞ÎÇò deliveryCycleÏù¥ 0Ïùº Í≤ΩÏö∞ 0 Î∞òÌôò
            }
            // 10Îã®ÏúÑ Î∞òÏò¨Î¶º Ï≤òÎ¶¨
            const perCyclePrice = Math.round(price / (28 / deliveryCycle) / 10) * 10;
            return perCyclePrice;
        },
        next() {
            this.onboarding =
                this.onboarding + 1 > this.windowCount ? 1 : this.onboarding + 1;
        },
        prev() {
            this.onboarding =
                this.onboarding - 1 <= 0 ? this.windowCount : this.onboarding - 1;
        },
        paginatedPackages(page) {
            // ÌéòÏù¥ÏßÄÏóê Îî∞Îùº Ìå®ÌÇ§ÏßÄÎ•º Î∞òÌôò
            const packagesPerPage = 4;
            const start = (page - 1) * packagesPerPage;
            const end = start + packagesPerPage;
            return this.topPackageList.slice(start, end);
        },
        onSearch: debounce(async function() {
            this.currentPage = 0;
            const params = {
                page: this.currentPage,
                size: this.pageSize,
                sort: this.sortOptionMap.get(this.sortOption),
                packageName: this.searchQuery
            };
            console.log(params);
            this.isLoading = true;

            try {
                const packageListResponse = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/product-service/product/no-auth/search`, { params });
                this.packageList = packageListResponse.data.content;
                this.isLastPage = packageListResponse.data.last;
            } catch (error) {
                console.error(error);
            } finally {
                this.isLoading = false;
            }
        }, 300),
        async loadPackage() {
            try {
                if (this.isLoading || this.isLastPage) return;
                this.isLoading = true;
                this.currentPage++;
                let params = {
                    page: this.currentPage,
                    size: this.pageSize,
                    sort: this.sortOptionMap.get(this.sortOption),
                    packageName: this.searchQuery
                }
                const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/product-service/product/no-auth`, { params });
                const additionalData = response.data.content;
                this.packageList = [...this.packageList, ...additionalData];
                this.isLastPage = response.data.last;
                this.isLoading = false;
            } catch (e) {
                console.log(e);
                this.isLoading = false;
            }
            console.log(this.currentPage);
        },
        scrollPagination() {
            const isBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
            if (isBottom && !this.isLastPage && !this.isLoading) {
                this.loadPackage();
            }
        },
        async addToWishList(packageProduct) {
            try {
                const memberId = localStorage.getItem('memberId');
                await axios.post(`${process.env.VUE_APP_API_BASE_URL}/member-service/wishlist/product/${packageProduct.id}`, {
                    headers: {
                        myId: memberId,
                    }
                });
                this.wishlistItems[packageProduct.id] = !this.wishlistItems[packageProduct.id];
                if (this.wishlistItems[packageProduct.id]) {
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    this.wishAnimation.set(packageProduct.id, true);
                    setTimeout(() => {
                        this.wishAnimation.set(packageProduct.id, false);
                    }, 1000); // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏßÄÏÜç ÏãúÍ∞Ñ Ï°∞Ï†à Í∞ÄÎä•
                }
            } catch (e) {
                console.log(e.message);
            }
        }
    }
}
</script>

<style scoped>
.custom-container {
    max-width: 1200px !important;
    /* ÏõêÌïòÎäî ÏµúÎåÄ Ìè≠ */
    margin: 0 auto !important;
    /* Ï§ëÏïô Ï†ïÎ†¨ */
    width: 100% !important;
    /* Ïª®ÌÖåÏù¥ÎÑàÏùò Ìè≠ÏùÑ 100%Î°ú ÏÑ§Ï†ï */
}

.select-wrapper {
    width: 100%;
    position: relative;
    display: inline-block
}

.dropdown-icon {
    position: absolute;
    top: 37%;
    right: -10px;
    transform: translateY(-50%);
    pointer-events: none;
    /* ÌÅ¥Î¶≠ Î∞©ÏßÄ */
}

.searchbar {
    display: flex;
    background-color: rgb(245 245 247);
    border-radius: 4px;
    justify-content: space-between;
    width: 100%;
}

.sort-select {
    background-color: rgb(245 245 247);
    width: 100%;
    margin: 0 2px 10px 15px;
    padding: 8px;
    padding-left: 12px;
    border-radius: 4px;
}

.search-icon {
    transition: color 0.3s ease;
}

/* Apply hover effect */
.search-icon:hover {
    cursor: pointer;
    transition: color 0.3s ease;
}

.package-image {
    object-fit: cover;
    transition: transform 0.3s ease;
    /* border-radius: 10px; */
    width: 260px;
    height: 320px;
}

.package-image:hover {
    transform: scale(1.05);
    cursor: pointer;
}

.custom-card-container {
    display: flex;
    justify-content: left;
}

.heart-icon {
    width: 17px;
    height: 17px;
}

.hr-style {
    border-bottom: 3px solid #efefef;
    border-radius: 3px;
}

.icon-colored {
    color: red;
}

.heart-emoji {
    position: absolute;
    top: -20px;
    /* ÌïÑÏöîÏóê Îî∞Îùº ÏúÑÏπò Ï°∞Ï†ï */
    left: 30%;
    transform: translateX(-50%);
    font-size: 24px;
    opacity: 0;
    animation: popUp 1s ease-in-out forwards;
}

@keyframes popUp {
    0% {
        opacity: 0;
        transform: translate(-50%, 0) scale(0);
    }

    50% {
        opacity: 1;
        transform: translate(-50%, -50px) scale(1.5);
    }

    100% {
        opacity: 0;
        transform: translate(-50%, -100px) scale(0);
    }
}

.banner-img {
    object-fit: contain;
    width: 100%;
    /* Î∂ÄÎ™®Ïùò ÎÑàÎπÑÏóê ÎßûÏ∂îÍ∏∞ */
    height: 100%;
    /* Î∂ÄÎ™®Ïùò ÎÜíÏù¥Ïóê ÎßûÏ∂îÍ∏∞ */
}

.sale-style {
    background-color: rgb(245, 77, 77);
    color: white;
    padding-right: 7px;
    padding-left: 7px;
    padding-bottom: 3px;
    padding-top: 5px;
    font-size: 10px;
    margin-bottom: 10px;
}
</style>
